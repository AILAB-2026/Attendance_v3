<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition Sites Dropdown Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        
        select, button, input {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .dropdown-container {
            margin: 20px 0;
        }
        
        #siteDropdown {
            width: 100%;
            max-width: 400px;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üéØ Face Recognition Sites Dropdown Test</h1>
    
    <div class="container info">
        <h3>üìã Test Instructions</h3>
        <p>This page demonstrates exactly how the mobile app should integrate with the face recognition sites API.</p>
        <ol>
            <li>Click "Login & Load Sites" to simulate the mobile app flow</li>
            <li>Check if the dropdown populates with sites</li>
            <li>Review the API calls and responses in the log</li>
        </ol>
    </div>

    <div class="container">
        <h3>üîê Step 1: Login & Load Sites</h3>
        <button onclick="loginAndLoadSites()">Login & Load Sites</button>
        <div id="loginStatus"></div>
    </div>

    <div class="container">
        <h3>üè¢ Step 2: Sites Dropdown</h3>
        <div class="dropdown-container">
            <label for="siteDropdown">Select Site:</label><br>
            <select id="siteDropdown" disabled>
                <option value="">Loading...</option>
            </select>
        </div>
        <div id="dropdownStatus"></div>
    </div>

    <div class="container">
        <h3>üìä API Log</h3>
        <div id="apiLog" class="log">Click "Login & Load Sites" to see API calls...</div>
    </div>

    <script>
        let sessionToken = null;
        const API_BASE_URL = 'http://localhost:3001';
        
        function log(message) {
            const logElement = document.getElementById('apiLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="container ${type}">${message}</div>`;
        }
        
        async function loginAndLoadSites() {
            try {
                log('üîê Starting login process...');
                
                // Step 1: Login
                const loginData = {
                    companyCode: "1",
                    employeeNo: "B1-W422",
                    password: "Test@123"
                };
                
                log(`üì§ POST ${API_BASE_URL}/auth/login`);
                log(`üìã Payload: ${JSON.stringify(loginData)}`);
                
                const loginResponse = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                log(`üì• Login Response: ${loginResponse.status} ${loginResponse.statusText}`);
                
                if (!loginResponse.ok) {
                    throw new Error(`Login failed: ${loginResponse.status}`);
                }
                
                const loginResult = await loginResponse.json();
                log(`üìã Login Result: ${JSON.stringify(loginResult, null, 2)}`);
                
                if (!loginResult.success) {
                    throw new Error(`Login unsuccessful: ${loginResult.message}`);
                }
                
                sessionToken = loginResult.data.sessionToken;
                updateStatus('loginStatus', '‚úÖ Login successful!', 'success');
                log(`‚úÖ Login successful, token: ${sessionToken.substring(0, 20)}...`);
                
                // Step 2: Load Sites
                log('\nüè¢ Loading sites for face recognition...');
                
                const sitesResponse = await fetch(`${API_BASE_URL}/faceRecognition/sites-projects`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`üì• Sites Response: ${sitesResponse.status} ${sitesResponse.statusText}`);
                
                if (!sitesResponse.ok) {
                    throw new Error(`Sites API failed: ${sitesResponse.status}`);
                }
                
                const sitesResult = await sitesResponse.json();
                log(`üìã Sites Result: ${JSON.stringify(sitesResult, null, 2)}`);
                
                if (sitesResult.success && sitesResult.data.sites) {
                    populateDropdown(sitesResult.data.sites, sitesResult.data.defaultSite);
                    updateStatus('dropdownStatus', `‚úÖ Loaded ${sitesResult.data.sites.length} sites successfully!`, 'success');
                    log(`‚úÖ Successfully loaded ${sitesResult.data.sites.length} sites`);
                } else {
                    throw new Error('No sites returned from API');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateStatus('loginStatus', `‚ùå Error: ${error.message}`, 'error');
                updateStatus('dropdownStatus', '‚ùå Failed to load sites', 'error');
            }
        }
        
        function populateDropdown(sites, defaultSite) {
            const dropdown = document.getElementById('siteDropdown');
            
            // Clear existing options
            dropdown.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a site...';
            dropdown.appendChild(defaultOption);
            
            // Add sites
            sites.forEach(site => {
                const option = document.createElement('option');
                option.value = site.siteId;
                option.textContent = site.siteName;
                
                // Set as selected if it's the default site
                if (defaultSite && site.siteId === defaultSite.siteId) {
                    option.selected = true;
                }
                
                dropdown.appendChild(option);
            });
            
            // Enable dropdown
            dropdown.disabled = false;
            
            log(`üìã Dropdown populated with ${sites.length} options`);
            if (defaultSite) {
                log(`‚≠ê Default site selected: ${defaultSite.siteName}`);
            }
        }
        
        // Handle dropdown change
        document.getElementById('siteDropdown').addEventListener('change', function(e) {
            const selectedSiteId = e.target.value;
            const selectedSiteName = e.target.options[e.target.selectedIndex].text;
            
            if (selectedSiteId) {
                log(`üéØ Site selected: ${selectedSiteName} (ID: ${selectedSiteId})`);
                updateStatus('dropdownStatus', `Selected: ${selectedSiteName}`, 'success');
            } else {
                log(`üîÑ Site selection cleared`);
                updateStatus('dropdownStatus', 'No site selected', 'info');
            }
        });
    </script>
</body>
</html>

import React, { useEffect, useMemo, useState } from 'react';
import { 
  StyleSheet, 
  View, 
  Text, 
  FlatList, 
  TouchableOpacity, 
  ActivityIndicator,
  Modal,
  ScrollView,
} from 'react-native';
import { Linking } from 'react-native';
import { startOfMonth, endOfMonth } from 'date-fns';
import { Image } from 'expo-image';
import { safeFormatDate, formatDateLocal } from '@/lib/date';
import DateRangePicker from '@/components/DateRangePicker';
import { DollarSign, Calendar, Download, X } from 'lucide-react-native';

import colors from '@/constants/colors';
import { spacing, radii, shadows, typography } from '@/constants/theme';
import { Payslip } from '@/types/payslip';
import { useAttendance } from '@/hooks/use-attendance-store';
import { useAuth } from '@/hooks/use-auth';
import { apiService } from '@/lib/api';

export default function PayslipsScreen() {
  const [modalVisible, setModalVisible] = useState(false);
  const [selectedPayslip, setSelectedPayslip] = useState<Payslip | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [payslips, setPayslips] = useState<Payslip[]>([]);
  const [refreshing, setRefreshing] = useState(false);
  const [listRange, setListRange] = useState<{ startDate: string; endDate: string }>(() => ({
    startDate: formatDateLocal(startOfMonth(new Date())),
    endDate: formatDateLocal(endOfMonth(new Date())),
  }));
  
  const { user: attendanceUser } = useAttendance();
  const { user: authUser } = useAuth();
  const user = authUser || attendanceUser;

  const initials = useMemo(() => {
    const name = (user as any)?.name || '';
    if (!name) return ((user as any)?.empNo || '').slice(0, 2).toUpperCase();
    const parts = String(name).trim().split(/\s+/);
    const first = parts[0]?.[0] || '';
    const last = parts.length > 1 ? parts[parts.length - 1][0] : '';
    return (first + last).toUpperCase();
  }, [user]);

  useEffect(() => {
    const load = async () => {
      if (!user?.companyCode || !user?.empNo) return;
      try {
        setIsLoading(true);
        setError(null);
        // Server-side date-range fetch for scalability
        const res = await apiService.getPayslips(user.companyCode, user.empNo, {
          startDate: listRange.startDate,
          endDate: listRange.endDate,
        });
        const data = (res as any)?.data || [];
        setPayslips(data as Payslip[]);
      } catch (e) {
        setError('Failed to load payslips. Please try again.');
        setPayslips([]);
      } finally {
        setIsLoading(false);
      }
    };
    load();
  }, [user?.companyCode, user?.empNo, listRange.startDate, listRange.endDate]);

  const [statusFilter, setStatusFilter] = useState<'all' | 'generated' | 'sent' | 'viewed'>('all');

  // Server already filtered by date range; de-duplicate by month and sort, then filter by status
  const visiblePayslips = useMemo(() => {
    const source = payslips;

    const byMonth = new Map<string, Payslip>();
    for (const p of source) {
      const key = safeFormatDate(p.payPeriodStart, 'yyyy-MM');
      const existing = byMonth.get(key);
      if (!existing) {
        byMonth.set(key, p);
        continue;
      }
      const score = (x: Payslip) => new Date(x.payDate || x.updatedAt || x.payPeriodEnd || x.payPeriodStart).getTime();
      if (score(p) > score(existing)) {
        byMonth.set(key, p);
      }
    }
    const list = Array.from(byMonth.values());
    list.sort((a, b) => new Date(b.payPeriodStart).getTime() - new Date(a.payPeriodStart).getTime());
    if (statusFilter === 'all') return list;
    return list.filter(p => p.status === statusFilter);
  }, [payslips, statusFilter]);

  const summary = useMemo(() => {
    const list = visiblePayslips;
    const totalGross = list.reduce((s, p) => s + Number(p.grossPay || 0), 0);
    const totalNet = list.reduce((s, p) => s + Number(p.netPay || 0), 0);
    const totalOTHours = list.reduce((s, p) => s + Number(p.overtimeHours || 0), 0);
    const totalOTPay = list.reduce((s, p) => s + Number(p.overtimePay || 0), 0);
    const counts = {
      generated: list.filter(p => p.status === 'generated').length,
      sent: list.filter(p => p.status === 'sent').length,
      viewed: list.filter(p => p.status === 'viewed').length,
    };
    return { totalGross, totalNet, totalOTHours, totalOTPay, counts };
  }, [visiblePayslips]);

  const onRefresh = async () => {
    if (!user?.companyCode || !user?.empNo) return;
    try {
      setRefreshing(true);
      const res = await apiService.getPayslips(user.companyCode, user.empNo, {
        startDate: listRange.startDate,
        endDate: listRange.endDate,
      });
      const data = (res as any)?.data || [];
      setPayslips(data as Payslip[]);
    } catch (e) {
      setPayslips([]);
    } finally {
      setRefreshing(false);
    }
  };

  const handlePayslipPress = async (payslip: Payslip) => {
    setSelectedPayslip(payslip);
    setModalVisible(true);
    
    if (payslip.status !== 'viewed') {
      try {
        if (user?.companyCode && user?.empNo) {
          await apiService.markPayslipViewed(user.companyCode, user.empNo, payslip.id);
          // Optimistically update local state
          setPayslips((prev) => prev.map((p) => p.id === payslip.id ? { ...p, status: 'viewed' } : p));
          setSelectedPayslip((prev) => prev ? { ...prev, status: 'viewed' } as Payslip : prev);
        }
      } catch (error) { }
    }
  };
  
  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
    }).format(amount);
  };
  
  const formatDate = (dateString: string) => {
    return safeFormatDate(dateString, 'MMM d, yyyy');
  };
  
  const getStatusColor = (status: Payslip['status']) => {
    switch (status) {
      case 'viewed': return colors.success;
      case 'sent': return colors.info;
      case 'generated': return colors.warning;
      default: return colors.textSecondary;
    }
  };
  
  const getStatusText = (status: Payslip['status']) => {
    switch (status) {
      case 'viewed': return 'Viewed';
      case 'sent': return 'Sent';
      case 'generated': return 'Generated';
      default: return status;
    }
  };
  
  const renderPayslipCard = ({ item }: { item: Payslip }) => (
    <TouchableOpacity 
      style={styles.payslipCard}
      onPress={() => handlePayslipPress(item)}
      testID={`payslip-card-${item.id}`}
    >
      <View style={styles.payslipHeader}>
        <View style={styles.payslipTitleContainer}>
          <DollarSign size={20} color={colors.primary} />
          <Text style={styles.payslipTitle}>
            {safeFormatDate(item.payPeriodStart, 'MMM yyyy')} Payslip
          </Text>
        </View>
        <View style={styles.rightHeaderRow}>
          <TouchableOpacity
            style={styles.smallDownload}
            onPress={() => {
              const companyCode = (user as any)?.companyCode || (user as any)?.cmpcode;
              const employeeNo = (user as any)?.empNo || (user as any)?.employeeNo;
              if (!companyCode || !employeeNo) return;
              const url = apiService.getPayslipPdfDownloadUrl(item.id, companyCode, employeeNo);
              Linking.openURL(url);
            }}
          >
            <Download size={16} color={colors.primary} />
          </TouchableOpacity>
          <View style={[styles.statusBadge, { backgroundColor: getStatusColor(item.status) }]}>
            <Text style={styles.statusText}>{getStatusText(item.status)}</Text>
          </View>
        </View>
      </View>
      
      <View style={styles.payslipDetails}>
        <View style={styles.detailRow}>
          <Calendar size={16} color={colors.textSecondary} />
          <Text style={styles.detailLabel}>Pay Period:</Text>
          <Text style={styles.detailValue}>
            {formatDate(item.payPeriodStart)} - {formatDate(item.payPeriodEnd)}
          </Text>
        </View>
        
        <View style={styles.detailRow}>
          <Text style={styles.detailLabel}>Pay Date:</Text>
          <Text style={styles.detailValue}>{formatDate(item.payDate)}</Text>
        </View>
      </View>
      
      <View style={styles.payslipSummary}>
        <View style={styles.summaryItem}>
          <Text style={styles.summaryLabel}>Gross Pay</Text>
          <Text style={styles.summaryValue}>{formatCurrency(item.grossPay)}</Text>
        </View>
        
        <View style={styles.summaryDivider} />
        
        <View style={styles.summaryItem}>
          <Text style={styles.summaryLabel}>Deductions</Text>
          <Text style={styles.summaryValue}>
            -{formatCurrency(item.taxDeduction + Object.values(item.deductions).reduce((sum, val) => sum + val, 0))}
          </Text>
        </View>
        
        <View style={styles.summaryDivider} />
        
        <View style={styles.summaryItem}>
          <Text style={[styles.summaryLabel, styles.netPayLabel]}>Net Pay</Text>
          <Text style={[styles.summaryValue, styles.netPayValue]}>{formatCurrency(item.netPay)}</Text>
        </View>
      </View>
    </TouchableOpacity>
  );
  
  const renderEmptyList = () => (
    <View style={styles.emptyContainer}>
      <DollarSign size={48} color={colors.textSecondary} />
      <Text style={styles.emptyText}>No payslips found in the selected date range</Text>
    </View>
  );
  
  if (isLoading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color={colors.primary} />
      </View>
    );
  }

  if (error) {
    return (
      <View style={styles.loadingContainer}>
        <Text style={styles.title}>Unable to load payslips</Text>
        <Text style={[styles.meta, { marginTop: 6, marginBottom: 12 }]}>{error}</Text>
        <TouchableOpacity style={styles.retryBtn} onPress={() => setListRange({ ...listRange })}>
          <Text style={styles.retryText}>Try Again</Text>
        </TouchableOpacity>
      </View>
    );
  }
  
  return (
    <View style={styles.container}>
      <View style={styles.profileHeader}>
        <View style={styles.profileRow}>
          {(user as any)?.profileImageUri ? (
            <Image
              source={{ uri: (user as any).profileImageUri }}
              style={{ width: 48, height: 48, borderRadius: 24 }}
              contentFit="cover"
            />
          ) : (
            <View style={styles.avatar}>
              <Text style={styles.avatarText}>{initials}</Text>
            </View>
          )}
          <View style={{ flex: 1 }}>
            <View style={styles.nameRow}>
              <Text style={styles.title} numberOfLines={1}>
                {(user as any)?.name || (user as any)?.empNo || 'Payslips'}
              </Text>
              {!!(user as any)?.companyCode && (
                <Text style={styles.companyBadge} numberOfLines={1}>
                  {(user as any)?.companyCode}
                </Text>
              )}
            </View>
            {!!(user as any)?.empNo && (
              <Text style={styles.meta}>Emp No: <Text style={styles.metaValue}>{(user as any)?.empNo}</Text></Text>
            )}
          </View>
        </View>
      </View>

      <DateRangePicker value={listRange} onChange={setListRange} />

      {/* Status filters and summary */}
      <View style={styles.statusTabs}>
        {(['all','generated','sent','viewed'] as const).map((s) => (
          <TouchableOpacity
            key={s}
            style={[styles.statusTab, statusFilter === s && styles.statusTabActive]}
            onPress={() => setStatusFilter(s)}
          >
            <Text style={[styles.statusTabText, statusFilter === s && styles.statusTabTextActive]}>
              {s === 'all' ? 'All Statuses' : getStatusText(s as any)}
            </Text>
          </TouchableOpacity>
        ))}
      </View>

      <View style={styles.kpiRow}>
        <View style={styles.kpiItem}>
          <Text style={styles.summaryLabel}>Gross</Text>
          <Text style={styles.summaryValue}>{formatCurrency(summary.totalGross)}</Text>
        </View>
        <View style={styles.kpiItem}>
          <Text style={styles.summaryLabel}>Net</Text>
          <Text style={[styles.summaryValue, styles.netPayValue]}>{formatCurrency(summary.totalNet)}</Text>
        </View>
        <View style={styles.kpiItem}>
          <Text style={styles.summaryLabel}>OT</Text>
          <Text style={styles.summaryValue}>{summary.totalOTHours.toFixed(1)}h / {formatCurrency(summary.totalOTPay)}</Text>
        </View>
      </View>
      
      <FlatList
        data={visiblePayslips}
        renderItem={renderPayslipCard}
        keyExtractor={(item) => item.id}
        contentContainerStyle={styles.listContent}
        ListEmptyComponent={renderEmptyList}
        showsVerticalScrollIndicator={false}
        refreshing={refreshing}
        onRefresh={onRefresh}
      />
      
      <Modal
        visible={modalVisible}
        animationType="slide"
        transparent={true}
        onRequestClose={() => setModalVisible(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Payslip Details</Text>
              <TouchableOpacity 
                style={styles.closeButton}
                onPress={() => setModalVisible(false)}
              >
                <X size={24} color={colors.text} />
              </TouchableOpacity>
            </View>
            
            <ScrollView style={styles.modalBody}>
              {selectedPayslip && (
                <>
                  <View style={styles.payslipInfo}>
                    <Text style={styles.payslipInfoTitle}>
                      {safeFormatDate(selectedPayslip.payPeriodStart, 'MMMM yyyy')} Payslip
                    </Text>
                    <Text style={styles.payslipInfoSubtitle}>
                      Pay Period: {formatDate(selectedPayslip.payPeriodStart)} - {formatDate(selectedPayslip.payPeriodEnd)}
                    </Text>
                    <Text style={styles.payslipInfoSubtitle}>
                      Pay Date: {formatDate(selectedPayslip.payDate)}
                    </Text>
                  </View>
                  
                  <View style={styles.section}>
                    <Text style={styles.sectionTitle}>Earnings</Text>
                    <View style={styles.sectionContent}>
                      <View style={styles.lineItem}>
                        <Text style={styles.lineItemLabel}>Basic Salary</Text>
                        <Text style={styles.lineItemValue}>{formatCurrency(selectedPayslip.basicSalary)}</Text>
                      </View>
                      
                      {selectedPayslip.overtimeHours > 0 && (
                        <View style={styles.lineItem}>
                          <Text style={styles.lineItemLabel}>
                            Overtime ({selectedPayslip.overtimeHours}h @ {formatCurrency(selectedPayslip.overtimeRate)}/h)
                          </Text>
                          <Text style={styles.lineItemValue}>{formatCurrency(selectedPayslip.overtimePay)}</Text>
                        </View>
                      )}
                      
                      {Object.entries(selectedPayslip.allowances).map(([key, value]) => (
                        <View key={key} style={styles.lineItem}>
                          <Text style={styles.lineItemLabel}>{key.charAt(0).toUpperCase() + key.slice(1)} Allowance</Text>
                          <Text style={styles.lineItemValue}>{formatCurrency(value)}</Text>
                        </View>
                      ))}
                      
                      <View style={styles.totalLine}>
                        <Text style={styles.totalLabel}>Gross Pay</Text>
                        <Text style={styles.totalValue}>{formatCurrency(selectedPayslip.grossPay)}</Text>
                      </View>
                    </View>
                  </View>
                  
                  <View style={styles.section}>
                    <Text style={styles.sectionTitle}>Deductions</Text>
                    <View style={styles.sectionContent}>
                      <View style={styles.lineItem}>
                        <Text style={styles.lineItemLabel}>Tax</Text>
                        <Text style={styles.lineItemValue}>-{formatCurrency(selectedPayslip.taxDeduction)}</Text>
                      </View>
                      
                      {Object.entries(selectedPayslip.deductions).map(([key, value]) => (
                        <View key={key} style={styles.lineItem}>
                          <Text style={styles.lineItemLabel}>{key.charAt(0).toUpperCase() + key.slice(1)}</Text>
                          <Text style={styles.lineItemValue}>-{formatCurrency(value)}</Text>
                        </View>
                      ))}
                      
                      <View style={styles.totalLine}>
                        <Text style={styles.totalLabel}>Total Deductions</Text>
                        <Text style={styles.totalValue}>
                          -{formatCurrency(selectedPayslip.taxDeduction + Object.values(selectedPayslip.deductions).reduce((sum, val) => sum + val, 0))}
                        </Text>
                      </View>
                    </View>
                  </View>
                  
                  <View style={styles.netPaySection}>
                    <View style={styles.netPayContainer}>
                      <Text style={styles.modalNetPayLabel}>Net Pay</Text>
                      <Text style={styles.netPayAmount}>{formatCurrency(selectedPayslip.netPay)}</Text>
                    </View>
                  </View>
                </>
              )}
            </ScrollView>
            
            <View style={styles.modalActions}>
              {selectedPayslip && (
                <TouchableOpacity 
                  style={styles.downloadButton}
                  onPress={() => {
                    const companyCode = (user as any)?.companyCode || (user as any)?.cmpcode;
                    const employeeNo = (user as any)?.empNo || (user as any)?.employeeNo;
                    if (!companyCode || !employeeNo) return;
                    const url = apiService.getPayslipPdfDownloadUrl(selectedPayslip.id, companyCode, employeeNo);
                    Linking.openURL(url);
                  }}
                >
                  <Download size={20} color={colors.primary} />
                  <Text style={styles.downloadButtonText}>Download PDF</Text>
                </TouchableOpacity>
              )}
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
    padding: spacing.lg,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: colors.background,
  },
  profileHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.card,
    borderRadius: radii.md,
    padding: spacing.md,
    marginBottom: spacing.md,
    ...shadows.card,
  },
  profileRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
  },
  avatar: {
    width: 48,
    height: 48,
    borderRadius: 24,
    backgroundColor: colors.primary + '20',
    alignItems: 'center',
    justifyContent: 'center',
  },
  avatarText: {
    color: colors.primary,
    fontWeight: '800',
    fontSize: 16,
  },
  nameRow: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  title: {
    fontSize: 16,
    fontWeight: '700',
    color: colors.text,
  },
  meta: {
    ...typography.caption,
    color: colors.textSecondary,
    marginTop: 2,
  },
  metaValue: {
    color: colors.text,
    fontWeight: '600',
  },
  companyBadge: {
    marginLeft: 8,
    paddingHorizontal: 8,
    paddingVertical: 2,
    borderRadius: radii.pill,
    backgroundColor: colors.badge.companyBg,
    borderWidth: 1,
    borderColor: colors.badge.companyBorder,
    color: colors.badge.companyText,
    fontSize: 12,
    fontWeight: '700',
    maxWidth: 100,
  },
  listContent: {
    paddingBottom: spacing.xl,
  },
  payslipCard: {
    backgroundColor: colors.card,
    borderRadius: 12,
    padding: 16,
    marginBottom: 12,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 2,
  },
  payslipHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  rightHeaderRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  payslipTitleContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  payslipTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.text,
    marginLeft: 8,
  },
  statusBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  statusText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: '600',
  },
  payslipDetails: {
    marginBottom: 16,
    gap: 8,
  },
  detailRow: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  detailLabel: {
    fontSize: 14,
    color: colors.textSecondary,
    marginLeft: 8,
    marginRight: 8,
  },
  detailValue: {
    fontSize: 14,
    color: colors.text,
    fontWeight: '500',
  },
  payslipSummary: {
    backgroundColor: colors.background,
    borderRadius: 8,
    padding: 12,
  },
  summaryItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 4,
  },
  summaryLabel: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  summaryValue: {
    fontSize: 14,
    color: colors.text,
    fontWeight: '500',
  },
  summaryDivider: {
    height: 1,
    backgroundColor: colors.border,
    marginVertical: 8,
  },
  kpiRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    backgroundColor: colors.card,
    borderRadius: radii.md,
    padding: spacing.md,
    marginBottom: spacing.md,
    ...shadows.card,
  },
  kpiItem: {
    flex: 1,
    alignItems: 'center',
  },
  statusTabs: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.sm,
    marginTop: spacing.sm,
    marginBottom: spacing.md,
  },
  statusTab: {
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.xs,
    borderRadius: radii.pill,
    borderWidth: 1,
    borderColor: colors.border,
    backgroundColor: colors.card,
  },
  statusTabActive: {
    backgroundColor: colors.primary + '15',
    borderColor: colors.primary,
  },
  statusTabText: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '600',
  },
  statusTabTextActive: {
    color: colors.primary,
    fontWeight: '800',
  },
  smallDownload: {
    backgroundColor: colors.primaryLight,
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  retryBtn: {
    backgroundColor: colors.primary,
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.sm,
    borderRadius: radii.sm,
    marginTop: spacing.sm,
  },
  retryText: {
    color: '#fff',
    fontWeight: '700',
  },
  netPayLabel: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.text,
  },
  netPayValue: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.primary,
  },
  emptyContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 40,
  },
  emptyText: {
    fontSize: 16,
    color: colors.textSecondary,
    textAlign: 'center',
    marginTop: 16,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContent: {
    width: '90%',
    maxHeight: '80%',
    backgroundColor: colors.card,
    borderRadius: 12,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
    elevation: 5,
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.text,
  },
  closeButton: {
    padding: 4,
  },
  modalBody: {
    padding: 16,
  },
  payslipInfo: {
    marginBottom: 24,
    alignItems: 'center',
  },
  payslipInfoTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.text,
    marginBottom: 8,
  },
  payslipInfoSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: 4,
  },
  section: {
    marginBottom: 24,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.text,
    marginBottom: 12,
  },
  sectionContent: {
    backgroundColor: colors.background,
    borderRadius: 8,
    padding: 12,
  },
  lineItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 6,
  },
  lineItemLabel: {
    fontSize: 14,
    color: colors.text,
    flex: 1,
  },
  lineItemValue: {
    fontSize: 14,
    color: colors.text,
    fontWeight: '500',
  },
  totalLine: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 8,
    marginTop: 8,
    borderTopWidth: 1,
    borderTopColor: colors.border,
  },
  totalLabel: {
    fontSize: 14,
    fontWeight: 'bold',
    color: colors.text,
  },
  totalValue: {
    fontSize: 14,
    fontWeight: 'bold',
    color: colors.text,
  },
  netPaySection: {
    backgroundColor: colors.primaryLight,
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
  },
  netPayContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  modalNetPayLabel: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.primary,
  },
  netPayAmount: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.primary,
  },
  modalActions: {
    padding: 16,
    borderTopWidth: 1,
    borderTopColor: colors.border,
  },
  downloadButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: colors.primaryLight,
    padding: 12,
    borderRadius: 8,
  },
  downloadButtonText: {
    color: colors.primary,
    fontWeight: '600',
    marginLeft: 8,
  },
});